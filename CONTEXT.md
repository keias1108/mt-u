<!-- @fileoverview 대화 맥락/의도 기록 (다음 세션 이어가기용). -->

# 계층 RD(튜링) 데모 — 세션 맥락 메모

이 문서는 “다음에 이어서 작업할 때 참고할 **맥락**”만 정리한 것입니다.  
특정 방향으로 강제하는 설계 문서/요구사항 고정본이 아닙니다.

## 1) 사용자가 말한 `ab`의 의미(중요)

- 사용자가 말한 `ab`는 곱(`a*b`)이 아니라 **튜플/묶음 `(a,b)`** 의미.
- 예: `a,b -> (a,b), c`에서 `(a,b)`는 “2개로 보이지만 **하나의 입력 묶음**”이라는 뜻.
- 즉 다음 레벨에서 `X1`을 만들 때 입력은 `(a,b)` 전체이며, “한 덩어리 입력을 받아” `X1 = f(a,b)` 형태가 되는 것이 핵심.

## 2) 사용자가 의도한 계층 구조(중첩 형태)

튜링 패턴이 기본적으로 2필드 `(X,Y)`로 동작한다고 보고, 레벨이 올라갈수록 다음처럼 중첩되는 형태를 원함:

- 0레벨: `(X0, Y0) = (a, b)`
- 1레벨: `(X1, Y1) = ( f(X0, Y0), c )` 를 기반으로 다시 2필드 RD
- 2레벨: `(X2, Y2) = ( f(X1, Y1), d )`
- 3레벨: `(X3, Y3) = ( f(X2, Y2), e )`

여기서 핵심은:
- 각 레벨은 항상 **2필드 RD**를 돌린다.
- 다음 레벨의 `Xk`는 이전 레벨의 `(X,Y)` “묶음”에서 만들어진 `f(X,Y)`를 사용한다.
- `Yk`(c,d,e,...)는 레벨마다 새로 등장하는 두 번째 필드다.

## 3) 구현 관점에서 꼭 필요한 것: `f(prevX, prevY)`

`(prevX, prevY)`를 “한 덩어리로 묶어서” 다음 레벨 `X_in`을 만들려면 결국 **사상 함수**가 필요함:

- `X_in = f(prevX, prevY)`

`f`는 아직 “사용자의 최종 선택이 확정된 것”은 아니고, 다음 세션에서 바꿀 수 있는 요소로 남겨둠.

## 4) 현재 구현 상태(이 세션 기준)

### 파일 구조(모듈화)

- `index.html` : UI 골격 + 스크립트 로드
- `styles.css` : 스타일
- `src/shaders.js` : GLSL 셰이더 문자열들
- `src/main.js` : WebGL 초기화, UI 바인딩, 시뮬 루프, 모드/계층 로직

### RD 모드(캐스케이드) 구현 요약

- Stage 0는 Gray-Scott `(a,b)`를 그대로 `(X0,Y0)`로 간주.
- Stage k(>=1)는 `(Xk, Yk)` 2필드로 RD를 돌림.
- Stage k는 “입력 텍스처”로 이전 stage의 상태 `(prevX, prevY)`를 받음(`uPrev`).
- `Xk` 업데이트 식에 **커플링 항**이 들어감:
  - `dx += drive * (X_in - X)`
  - `drive`는 `X`가 입력 `X_in`을 얼마나 강하게 따라갈지(추종/결합 강도).
- `X_in`은 현재 기본으로 다음 형태의 `f(prevX, prevY)`를 사용 중:
  - `X_in = clamp(prevX * prevY^2, 0..1)`
  - 주의: 이건 “사용자가 말한 `ab`(튜플)”를 곱으로 오해한 게 아니라,
    “튜플 입력을 1채널로 사상하기 위한 `f`를 임시로 하나 선택”한 것.

### RD 모드에서 구조(Struct) 시스템 분리

- RD 모드에서는 구조 레이어(A,B,...) 계산과 전역 억제 C 시스템을 **비활성** 처리.
- RD 모드 UI에서는 구조모드 전용 컨트롤(전역 억제 강도, C 평활, C 소스, A 감도 등)을 숨김.

### 계층 추가 시 Freeze 정책

- RD 모드에 “계층 추가 시 이전 단계 고정” 체크박스가 추가됨:
  - 체크 변경 시: 즉시 실시간 반영 대신 **리셋 후 재시작** 방식으로 단순화.
  - 목적: 계층 효과 관찰/디버그를 쉽게 하려는 옵션.

## 5) 다음 세션에서 결정/확장할 수 있는 포인트(열린 선택지)

아래는 “이 방향으로 해야 한다”가 아니라, 이어서 작업할 때 선택/조정 가능한 항목 목록:

1) `f(prevX, prevY)`를 무엇으로 둘지
   - 예: `prevX`, `prevY`, `prevX+prevY`, `prevX*prevY^2`, `min/max`, 정규화/커브 등
   - “튜플 `(X,Y)`를 한 덩어리로 쓰되 1채널로 요약”하는 방식 선택 문제

2) `drive` 해석/범위/디폴트
   - `drive=0`이면 단계 간 결합이 약해지고 각 단계가 더 독립적으로 행동
   - `drive`가 커질수록 중첩(추종) 성질이 강해짐

3) Freeze 정책의 기본값과 UX
   - “이전 단계 freeze” vs “새 단계 freeze” vs “모두 unfrozen”
   - 토글 시 리셋 외에 더 자연스러운 전환(원하면)도 가능

4) RD 모드 파라미터 구성
   - 현재 Stage0는 전역 슬라이더로, Stage>=1은 stage별 슬라이더로 제어
   - 필요하면 Stage0도 stage 카드로 내리거나, 전역/로컬 파라미터를 재구성 가능

